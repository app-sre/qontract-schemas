---
"$schema": /metaschema-1.json
version: '1.0'
type: object
title: "App Interface Prometheus Rule Test"
description: |
  Schema for defining Prometheus rule tests in app-interface. 
  This includes configurations for rule files, evaluation intervals, 
  test cases, and expected outputs.

additionalProperties: false

properties:
  "$schema":
    type: string
    enum:
    - /app-interface/prometheus-rule-test-1.yml

  rule_files:
    type: array
    description: |
      A list of Prometheus rule files to be tested.
    items:
      type: string

  evaluation_interval:
    type: string
    description: |
      The interval at which Prometheus evaluates the rules.

  group_eval_order:
    type: array
    description: |
      The order in which rule groups are evaluated.
    items:
      type: string

  tests:
    type: array
    description: |
      A list of test cases for Prometheus rules.
    items:
      type: object
      additionalProperties: false
      properties:
        interval:
          type: string
          description: |
            The interval at which the test is executed.

        input_series:
          type: array
          description: |
            A list of input time series for the test.
          items:
            type: object
            additionalProperties: false
            properties:
              series:
                type: string
                description: |
                  The name of the input time series.
              values:
                type: string
                description: |
                  The values for the input time series.
            required:
            - series
            - values

        alert_rule_test:
          type: array
          description: |
            A list of alert rule tests to validate alerting behavior.
          items:
            type: object
            additionalProperties: false
            properties:
              eval_time:
                type: string
                description: |
                  The evaluation time for the alert rule test.
              alertname:
                type: string
                description: |
                  The name of the alert being tested.
              exp_alerts:
                type:
                - array
                - "null"
                description: |
                  The expected alerts generated by the test.
                items:
                  type: object
                  additionalProperties: false
                  properties:
                    exp_labels:
                      type: object
                      description: |
                        The expected labels for the alert.
                    exp_annotations:
                      type: object
                      description: |
                        The expected annotations for the alert.
                  required:
                  - exp_labels
                  - exp_annotations
            required:
            - eval_time
            - alertname

        promql_expr_test:
          type: array
          description: |
            A list of PromQL expression tests to validate query behavior.
          items:
            type: object
            additionalProperties: false
            properties:
              expr:
                oneOf:
                - type: string
                - type: integer
                description: |
                  The PromQL expression being tested.
              eval_time:
                type: string
                description: |
                  The evaluation time for the PromQL expression test.
              exp_samples:
                type: array
                description: |
                  The expected samples generated by the PromQL expression.
                items:
                  type: object
                  additionalProperties: false
                  properties:
                    labels:
                      type: string
                      description: |
                        The labels for the expected sample.
                    value:
                      type: number
                      description: |
                        The value of the expected sample.
                  required:
                  - labels
                  - value

        external_labels:
          type: object
          description: |
            External labels applied to the test environment.

      required:
      - interval
      - input_series

required:
- "$schema"
- rule_files
- tests
