---
"$schema": /metaschema-1.json
version: "1.0"
type: object
title: "Integration Spec"
description: |
  Schema for defining the deployment specification of an integration.
  This includes configuration for command, resources, logging, environment
  variables, storage, scheduling, and other runtime options. The spec is
  used by the integrations manager to generate OpenShift resources and
  control integration behavior.

additionalProperties: false
properties:
  "$schema":
    type: string
    enum:
    - /app-sre/integration-spec-1.yml

  cache:
    type: boolean
    description: |
      Indicates if the integration requires a cache to store intermediate
      or persistent data during execution.

  command:
    type: string
    enum:
    - qontract-reconcile
    - app-interface-metrics-exporter
    - app-interface-reporter
    - glitchtip-access-reporter
    - glitchtip-access-revalidation
    - saas-metrics-exporter
    description: |
      The command to run for this integration. This determines the main
      entrypoint or executable for the integration container.

  disableUnleash:
    type: boolean
    description: |
      If true, disables the integration's interaction with the Unleash
      instance for feature flag management.

  environmentAware:
    type: boolean
    description: |
      Indicates whether the integration is aware of the environment it is
      running in. If true, environment-specific configuration may be used.

  extraArgs:
    type: string
    description: |
      Additional arguments to pass to the integration command at runtime.

  extraEnv:
    type: array
    description: |
      Additional environment variables to set for the integration. Each
      entry can specify a static value or reference a secret.
    items:
      type: object
      description: |
        Defines an environment variable for the integration, either by
        referencing a secret or by specifying a name and value directly.
      additionalProperties: false
      properties:
        secretName:
          type: string
          description: |
            The name of the secret to get the environment variable from.
        secretKey:
          type: string
          description: |
            The key within the secret to use as the environment variable value.
        name:
          type: string
          description: |
            The name of the environment variable to set.
        value:
          type: string
          description: |
            The value to assign to the environment variable.
      oneOf:
      - additionalProperties: false
        properties:
          secretName:
            type: string
          secretKey:
            type: string
        required:
        - secretName
        - secretKey
      - additionalProperties: false
        properties:
          name:
            type: string
          value:
            type: string
        required:
        - name
        - value

  imageRef:
    type: string
    description: |
      The image reference to use for the integration container.

  internalCertificates:
    type: boolean
    description: |
      If true, the integration requires internal certificates to execute.

  logs:
    type: object
    description: |
      Configuration for shipping logs to external providers. By default,
      logs are sent to CloudWatch. Additional providers can be enabled.
    additionalProperties: false
    properties:
      slack:
        type: boolean
        description: |
          If true, ship logs to Slack.
      googleChat:
        type: boolean
        description: |
          If true, ship logs to Google Chat.

  resources:
    "$ref": "/openshift/deploy-resources-1.yml"
    description: |
      Resource requirements for the integration container, such as CPU
      and memory requests and limits.

  fluentdResources:
    "$ref": "/openshift/deploy-resources-1.yml"
    description: |
      Resource requirements for the Fluentd sidecar, if used for log
      forwarding.

  sleepDurationSecs:
    type: string
    description: |
      Time to sleep, in seconds, between integration executions.

  state:
    type: boolean
    description: |
      Indicates if the integration is stateful and maintains persistent
      state between runs.

  storage:
    type: string
    description: |
      The size of cache storage to allocate for the integration.

  storageClassName:
    type: string
    enum:
    - gp2
    - gp2-csi
    - gp3-csi
    description: |
      The Kubernetes storage class name to use for the cache volume.

  trigger:
    type: boolean
    description: |
      If true, this integration acts as an openshift-saas-deploy integration trigger.

  cron:
    type: string
    pattern: '(((\d+,)+\d+|(\d+(\/|-)\d+)|\d+|\*) ?){5}'
    description: |
      Cron expression that defines the schedule for integration execution.

  dashdotdb:
    type: boolean
    description: |
      If true, the integration interacts with dashdotdb.

  concurrencyPolicy:
    type: string
    enum:
    - Allow
    - Forbid
    - Replace
    description: |
      Policy for handling concurrent executions of the integration.

  restartPolicy:
    type: string
    enum:
    - Always
    - OnFailure
    - Never
    description: |
      The restart policy for the integration container.

  successfulJobHistoryLimit:
    type: integer
    description: |
      The number of successful job history records to retain.

  failedJobHistoryLimit:
    type: integer
    description: |
      The number of failed job history records to retain.

  enablePushgateway:
    type: boolean
    description: |
      If true, push metrics to the configured Pushgateway at the end of
      each run.

required:
- resources
